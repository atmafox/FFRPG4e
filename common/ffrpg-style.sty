\ProvidesPackage{ffrpg-style}

\RequirePackage{geometry}
\RequirePackage[table,xcdraw,svgnames]{xcolor}
\RequirePackage{fontspec}
\RequirePackage{graphicx}
\RequirePackage{multicol}
\RequirePackage{enumitem}
\RequirePackage{fancyhdr}
\RequirePackage{titlesec}
\RequirePackage{placeins}
\RequirePackage{hyperref}
\RequirePackage{booktabs}
\RequirePackage{adjustbox}
\RequirePackage{indentfirst}
\RequirePackage{url}
\RequirePackage{keyreader}
\RequirePackage{fmtcount}
\RequirePackage{calc}
\RequirePackage{csquotes}

% We'll need @ for keyval templates in here
\makeatletter

% configure page geometry
\geometry{
  letterpaper,
  top=0.65in,
  left=0.5in,
  right=0.5in,
  bottom=0.25in,
  footskip=40pt,
  includefoot
}

% Get our common images added to the path
\graphicspath{{../img/}}

% Get our fonts set up, ferrum is missing styles so fake them
\providefontfamily\ferrum{ferrum.otf}[
	Path			= ../common/font/,
	AutoFakeSlant	= 0.2,
	AutoFakeBold	= 1.5 ]
\providefontfamily\arabtype{arabtype.ttf}[
	Path			= ../common/font/,
	AutoFakeSlant	= 0.2,
	AutoFakeBold	= 1.5 ]
\providefontfamily\yumin{yumin.ttf}[
	Path			= ../common/font/,
	AutoFakeSlant	= 0.2,
	AutoFakeBold	= 1.5 ]
\setmainfont{caladea}[
	Path = ../common/font/,
	Extension = .ttf,
	UprightFont = *-regular,
	BoldFont = *-bold,
	ItalicFont = *-italic,
	BoldItalicFont = *-bolditalic,
	]

% Colours for the two characters
\definecolor{mogred}{cmyk}{0, 0.78, 0.93, 0.55}
\definecolor{bocoblue}{cmyk}{0.95, 0.78, 0, 0.25}

% This is for leaving temporary inline comments about game mechanics that need clarification and that sort of thing. It should stand out badly but not be hard to read. It should probably also flag a warning in the console every time it's used.
\newcommand{\review}[1]{
	\bgroup\color{red}\textbf{((#1))}\egroup
}

% Macro for the crystal images
% I want to make this verify the input, but for now... this works
\newcommand{\crystal}[2]{
  \adjincludegraphics[valign=M,height=#2]{../img/common/crystal#1.pdf}
}

% Types of terms
% Magic system
\newcommand{\tspell}[1]{\textit{#1}}
\newcommand{\tspellgroup}[1]{\textbf{#1}}
\newcommand{\tspellblue}[1]{\tspell{#1}}
% Character build pieces
\newcommand{\tability}[1]{\textbf{\textit{#1}}}
\newcommand{\tspec}[1]{\textit{#1}}
\newcommand{\taction}[1]{\textbf{!#1}}
\newcommand{\tsummon}[1]{\textbf{#1}}
\newcommand{\tperformance}[1]{\textbf{#1}}
\newcommand{\tquirk}[1]{\textbf{#1}}
\newcommand{\ttrait}[1]{#1}
\newcommand{\tjob}[1]{#1}
\newcommand{\tskill}[1]{\textbf{#1}}
% Equipment
\newcommand{\tequip}[1]{#1}
\newcommand{\titem}[1]{#1}
% Elements/damage types
\newcommand{\telem}[1]{#1}
% Attack classes
\newcommand{\tatk}[1]{#1}

% Optional rules
\newcommand{\toption}[1]{\textbf{#1}}

% Status types 
\newcommand{\tstatus}[1]{\textbf{#1}}

% mob ranks
\newcommand{\tmob}[1]{\textbf{#1}}
\newcommand{\tmobmini}[1]{\tmob{Minion}}
\newcommand{\tmobcomm}[1]{\tmob{Common}}
\newcommand{\tmobleet}[1]{\tmob{Elite}}
\newcommand{\tmobboss}[1]{\tmob{Boss}}

% mob types
\newcommand{\tmtype}[1]{\textbf{#1}}
\newcommand{\tmtypeaberr}{\tmtype{Aberration}}
\newcommand{\tmtypeaqua}{\tmtype{Aquan}}
\newcommand{\tmtypeconstr}{\tmtype{Construct}}
\newcommand{\tmtypedemon}{\tmtype{Demon}}
\newcommand{\tmtypedrgn}{\tmtype{Dragon}}
\newcommand{\tmtypeelem}{\tmtype{Elemental}}
\newcommand{\tmtypebeast}{\tmtype{Beast}}
\newcommand{\tmtypehuman}{\tmtype{Humanoid}}
\newcommand{\tmtypeundead}{\tmtype{Undead}}
\newcommand{\tmtypeinvalid}{\tmtype{INVALID}}


% specific kinds of rules text
%\colorlet{rulebg}{gray!20}
%\newcommand{actionrule}[1]{
%	\sethlcolor{rulebg}\hl{
%		#1
%	}
%}

% parskip standard sizes
\newcommand{\pc}{\parskip 10pt}
\newcommand{\pw}{\parskip 15pt}

% Also, let's make define a nice minipage wrapper
\newenvironment{ffminipage}{%
  \noindent\begin{minipage}{\textwidth}%
}{%
  \end{minipage}\vspace{\parskip}%
}

% And one for two-column view
\newenvironment{ffcolpage}{%
  \noindent\begin{minipage}{\dimexpr 0.5\textwidth-0.5\columnsep}%
}{%
  \end{minipage}\vspace{\parskip}%
}

% for all choices
\krddefinekeys{jobchoice}[jc@]{bool/header;cmd/text;}
\krdpresetkeys{jobchoice}{header=true,text=Specialties}

\newenvironment*{jobchoice}[1][]{
	\krdsetkeys{jobchoice}{#1}
	\begin{tabular}{W{r}{\dimexpr 0.15\linewidth-2\tabcolsep}p{\dimexpr 0.8\linewidth-2\tabcolsep}}
		\ifjc@header%
			\textbf{\jc@text}:\\
		\fi%
} {
  \end{tabular}
}

\krddefinekeys{actype}[ac@]{
	choice/slow/quick/
		quick.do=\def\ac@slow{Quick},
		1.do=\def\ac@slow{Slow (1)},
		2.do=\def\ac@slow{Slow (2)},
		3.do=\def\ac@slow{Slow (3)},
		4.do=\def\ac@slow{Slow (4)},
		5.do=\def\ac@slow{Slow (5)},
		6.do=\def\ac@slow{Slow (6)},
		7.do=\def\ac@slow{Slow (7)},
		8.do=\def\ac@slow{Slow (8)},
		9.do=\def\ac@slow{Slow (9)};
	bool/reaction;
	bool/magical;
	bool/ranged;
	bool/free;
}
\krdpresetkeys{actype}{reaction=false,magical=false,ranged=false,free=false,slow=quick}

\newcommand*{\actype}[1][]{
	\krdsetkeys{actype}{#1}%
	\textit{%
		\ifac@ranged%
			Ranged
		\fi%
		\ifac@magical%
			Magical
		\fi%
		\ifac@free%
			Free
		\else%
		\ac@slow{}
		\fi%
	}%
	\ifac@reaction%
		reaction%
	\else%
		action%
	\fi%
}

\krddefinekeys{jobstats}[js@]{%
	cmd/lva/1;
	cmd/lvb/15;
	cmd/lvc/30;
	cmd/lvd/60;
	cmd/hpa/;
	cmd/hpb/;
	cmd/hpc/;
	cmd/hpd/;
	cmd/mpa/;
	cmd/mpb/;
	cmd/mpc/;
	cmd/mpd/;
	cmd/armor/;
	cmd/weapons/;
}
\krdpresetkeys{jobstats}{%
	lva=1,lvb=15,lvc=30,lvd=60,
	hpa=,hpb=,hpc=,hpd=,mpa=,mpb=,mpc=,mpd=,armor=,weapons=}

\newcommand*{\jobstats}[1][]{
	\krdsetkeys{jobstats}{#1}%
  \begin{center}
	\rowcolors{1}{gray!10}{}
	\begin{tabular}{cp{10mm}p{10mm}p{10mm}p{10mm}}
	  \toprule
			Level & \js@lva & \js@lvb & \js@lvc & \js@lvd \\ \midrule
			HP Bonus & \js@hpa & \js@hpb & \js@hpc & \js@hpd \\
			MP Bonus & \js@mpa & \js@mpb & \js@mpc & \js@mpd \\
			Armor   & \multicolumn{4}{l}{ \js@armor } \\
		Weapons & \multicolumn{4}{l}{\begin{tabular}{@{}l} \js@weapons \\ \end{tabular}} \\
	  \bottomrule
	\end{tabular}
  \end{center}
}

% mob stat block
\krddefinekeys{mobstats}[ms@]{%
	cmd/name/MOBNAME;
	cmd/level/-;
	choice/rank/common/
		minion.do=\let\ms@rank\tmobmini\let\ms@init2,
		common.do=\let\ms@rank\tmobcomm\let\ms@init3,
		elite.do=\let\ms@rank\tmobleet\let\ms@init4,
		boss.do=\let\ms@rank\tmobboss\let\ms@init5;
	choice/type/invalid/
		invalid.do=\let\ms@type\tmtypeinvalid,
		abberation.do=\let\ms@type\tmtypeaberr,
		aquatic.do=\let\ms@type\tmtypeaqua,
		construct.do=\let\ms@type\tmtypeconstr,
		demon.do=\let\ms@type\tmtypedemon,
		dragon.do=\let\ms@type\tmtypedrgn,
		elemental.do=\let\ms@type\tmtypeelem,
		beast.do=\let\ms@type\tmtypebeast,
		humanoid.do=\let\ms@type\tmtypehuman,
		undead.do=\let\ms@type\tmtypeundead;
	cmd/earth/-;
	cmd/air/-;
	cmd/fire/-;
	cmd/water/-;
	cmd/hp/-;
	cmd/mp/-;
	cmd/arm/-;
	cmd/marm/-;
	cmd/init/3;
}
\krdpresetkeys{mobstats}{%
	name=MOBNAME,level=-,rank=common,type=invalid,init=3,
	earth=-,air=-,fire=-,water=-,hp=-,mp=-,arm=-,marm=-
}

\newlength{\numwidth}
\settowidth{\numwidth}{0}

\newcommand{\mobstatrow}[1]{#1 \\}

\newenvironment*{mobstats}[1][] {%
	\krdsetkeys{mobstats}{#1}
	\bgroup\ferrum\large\itshape \ms@name\egroup \pc

	\rowcolors{1}{gray!10}{}%
	\begin{tabular*}{\textwidth}{p{\textwidth-2\tabcolsep}}
		\toprule
	% Icon stuff after hfill if we get there
		\mobstatrow{ \ordinalnum{\ms@level{}} Level \ms@rank{} \ms@type{} \hfill} \midrule
		\rowcolors{1}{}{gray!10}
		{\centering %
		\begin{tabular}{*{3}{r>{\raggedleft\arraybackslash}p{5\numwidth}}}
			\textbf{Earth}: & \ms@earth & \textbf{Air}: & \ms@air & \textbf{HP}: & \ms@hp \\
			\textbf{Fire}: & \ms@fire & \textbf{Water}: & \ms@water & \textbf{MP}: & \ms@mp \\
			\textbf{ARM}: & \ms@arm & \textbf{MARM}: & \ms@marm & \textbf{Init}: & \ms@init \\
		\end{tabular} } \\ \midrule
} {
	\bottomrule
	\end{tabular*}\\[2mm]
}

% Define our options for the below
\krddefinekeys{jobdesc}[jd@]{%
  cmd/name/invalid;
}
\krdpresetkeys{jobdesc}{name=invalid}


% Display the job image, possibly the shadow
\newcommand{\jobimage}[1]{
	\parbox[right]{0.3\textwidth}{
		\adjincludegraphics[width=0.3\textwidth,trim={2.5in 0 0 0}]{#1}
	}
}

% And now, the 'standard' layout for job description
\newenvironment*{jobdesc}[1][]{%
	\krdsetkeys{jobdesc}{#1}
	\begin{minipage}[c]{0.65\textwidth}
}{
	\end{minipage}
	\jobimage{\jd@name}
}

% Display the quirk image, possibly the shadow
\newcommand{\quirkimage}[1]{
	\parbox[right]{0.15\textwidth}{
		\adjincludegraphics[width=0.15\textwidth]{#1}
	}
}

% Armor table
\krddefinekeys{tabarm}[ta@]{%
	cmd/label/undefined;
}
\krdpresetkeys{tabarm}{
	label=undefined
}

\krddefinekeys{tabarmrow}[tar@]{%
	cmd/name/UNDEFINED;
	cmd/mlevel/1;
	cmd/cost/-;
	cmd/arm/-;
	cmd/marm/-;
	cmd/effect/None;
}
\krdpresetkeys{tabarmrow}{
	name=UNDEFINED,mlevel=-,cost=-,arm=-,marm=-,effect=UNDEFINED
}

\newenvironment*{tabarm}[1][]{%
	\krdsetkeys{tabarm}{#1}%
	\begin{table}[h]
		\centering
		\label{tab:\ta@label}
	    \rowcolors{1}{gray!20}{}
		\begin{tabular}{lrrrrp{0.35\textwidth}}
        		\toprule
        		\textbf{Name} & \textbf{Level} & \textbf{Cost} & \textbf{ARM} & \textbf{MARM} & \textbf{Effect} \\ \midrule
}{
			\bottomrule
		\end{tabular}
	\end{table}
}

\newcommand*{\tabarmrow}[1][]{
  \krdsetkeys{tabarmrow}{#1} \tar@name &
  \krdsetkeys{tabarmrow}{#1} \tar@mlevel &
  \krdsetkeys{tabarmrow}{#1} \tar@cost &
  \krdsetkeys{tabarmrow}{#1} \tar@arm &
  \krdsetkeys{tabarmrow}{#1} \tar@marm &
  \krdsetkeys{tabarmrow}{#1} \tar@effect \\
}

% Weapon table
% Define oure options for the below
\krddefinekeys{tabwpn}[tw@]{%
	cmd/label/undefined;
	cmd/roll/UNDEF;
	cmd/type/UNDEF;
	cmd/range/UNDEF;
	cmd/element/UNDEF;
}
\krdpresetkeys{tabwpn}{
	label=undefined,roll=UNDEF,type=UNDEF,range=UNDEF,element=UNDEF
}

\krddefinekeys{tabwpnrow}[twr@]{%
	cmd/name/UNDEFINED;
	cmd/mlevel/1;
	cmd/cost/-;
	cmd/damage/-;
	cmd/effect/None;
}
\krdpresetkeys{tabwpnrow}{
	name=UNDEFINED,mlevel=-,cost=-,damage=-,effect=UNDEFINED
}

\newenvironment*{tabwpn}[1][]{%
	\krdsetkeys{tabwpn}{#1}%
	\begin{table}[h]
		\centering
		\label{tab:\tw@label}
	    \rowcolors{1}{}{gray!20}
		\begin{tabular}{lrrrp{0.4\textwidth}}
				\toprule
				\multicolumn{5}{l}{\tw@range \hspace{\stretch{1}} \tw@type \hspace{\stretch{1}} \tw@element \hfill \tw@roll} \\ \toprule
        		\textbf{Name} & \textbf{Level} & \textbf{Cost} & \textbf{Damage} & \textbf{Effect} \\ \midrule
}{
			\bottomrule
		\end{tabular}
	\end{table}
}

\newcommand*{\tabwpnrow}[1][]{
  \krdsetkeys{tabwpnrow}{#1} \twr@name &
  \krdsetkeys{tabwpnrow}{#1} \twr@mlevel &
  \krdsetkeys{tabwpnrow}{#1} \twr@cost &
  \krdsetkeys{tabwpnrow}{#1} \twr@damage &
  \krdsetkeys{tabwpnrow}{#1} \twr@effect \\
}

% Column centered Boco, inherit existing columns
\newenvironment{boco}{
 	 \noindent\begin{minipage}[t]{\dimexpr 0.5\textwidth-0.5\columnsep}
	 \par\medskip
	 \yumin
	 \begin{center}
	 \includegraphics[width=0.1\textwidth]{../img/common/boco}
	 \end{center}
	 \bgroup\color{bocoblue}\small%
	}
	{\egroup
	 \end{minipage}
	 \medskip}

% Used for page centered Boco but two column text
\newenvironment{multiboco}{
	 \par\medskip
	 \yumin
	 \begin{center}
	 \includegraphics[width=0.075\textwidth]{../img/common/boco}
	 \end{center}
	 \begin{multicols}{2}
	 \bgroup\color{bocoblue}\small%
	}
	{\egroup
	 \end{multicols}
	 \medskip}

% Column centered Mog, inherit existing columns
\newenvironment{mog}{
 	 \noindent\begin{minipage}[t]{\dimexpr 0.5\textwidth-0.5\columnsep}
	 \par\medskip
	 \arabtype
	 \begin{center}
	 \includegraphics[width=0.1\textwidth]{../img/common/mog}
	 \end{center}
	 \bgroup\color{mogred}\Large%
	}
	{\egroup
	 \end{minipage}
	 \medskip}

% Page centered mog, two column text
\newenvironment{multimog}{
	 \par\medskip
	 \arabtype
	 \begin{center}
	 \includegraphics[width=0.075\textwidth]{../img/common/mog}
	 \end{center}
	 \begin{multicols}{2}
	 \bgroup\color{mogred}\Large%
	}
	{\egroup
	 \end{multicols}
	 \medskip}

% Get all our header/footers done
\pagestyle{fancy}
  \fancyhf{}
  \renewcommand{\chaptermark}[1]{\markboth{#1}{}}
  \fancyfoot[C]{%
	\crystal{earth}{10pt} \hspace{\stretch{1}} %
	\crystal{air}{10pt} \hspace{\stretch{1}} %
	{\ferrum \leftmark\ - Page \thepage } \hspace{\stretch{1}} %
	\crystal{fire}{10pt} \hspace{\stretch{1}} %
	\crystal{water}{10pt}
  }

% And headers/footers for the chapter pages
\fancypagestyle{plain}{%
  \fancyhf{}
  \fancyfoot[C]{%
    \hspace{\stretch{1}} %
	\crystal{earth}{10pt} \hspace{\stretch{1}} %
	\crystal{air}{10pt} \hspace{\stretch{1}} %
	{\ferrum Chapter \thechapter } \hspace{\stretch{1}} %
	\crystal{fire}{10pt} \hspace{\stretch{1}} %
	\crystal{water}{10pt} \hspace{\stretch{1}}
	}
  }

% Alright, let's set appropriate section layouts
\titleformat{\chapter}{\ferrum\huge\bfseries\itshape\centering}{\thechapter}{1em}{}
\titleformat{\section}{\ferrum\LARGE\itshape\centering}{\thesection}{1em}{}
\titleformat{\subsection}{\ferrum\Large\upshape\centering}{\thesubsection}{1em}{}
\titleformat{\subsubsection}{\ferrum\large\itshape}{\thesubsubsection}{1em}{}

% Return @ processing to normal
\makeatother

\endinput
